# NodeJS scalable solution with Open Charge Map integration + MongoDB
## DESCRIPTION
## USER STORIES
- **User story 01:** As a project architect, I want Docker images to be built for each service to ensure they can be deployed to a Kubernetes cluster.
- **User story 02:** As a project architect, I want services to be designed for scalability, taking into account potential timeouts and other issues that might impact uptime.
- **User story 03:** As a project architect, I want a /graphql endpoint provided for each service, serving a sub-graph that can be accessed through a federated GraphQL gateway to serve data for several clients.
- **User story 04:** As a project architect, I want data to be stored in a MongoDB database, using UUIDs (v4) instead of the default ObjectIds for internal identification.
- **User story 05:** As a project architect, I want a service that fetches the latest charging station data from Open Charge Map and updates the database only when changes are detected.
- **User story 06:** As a project architect, I want the /graphql endpoint to list all imported charging stations, with relay-style pagination to navigate through the results.
- **User story 07:** As a project architect, I want separate Docker images to be created for the data pulling and the service itself.
- **User story 08:** As a project architect, I want the following fields from Open Charge Map to be imported:
    - operatorInfo,
    - statusType,
    - addressInfo, 
    - connections.
- **User story 09:** As a project architect, I want a single command to run the entire service and import process locally, along with instructions and a docker-compose file for the additional local infrastructure.
- **User story 10:** (Bonus) As a project architect, I want a minimum of 50% unit test coverage and at least one end-to-end test for the solution.

## ASSUMPTIONS
- use monorepo for all components
- to demonstrate how the project works, it is enough to have docker images for all components and a docker-compose file, there is no need to create Kubernetes config
- to synchronize with OCM, I use the undocumented modifiedsince parameter to fulfill the requirement to receive only the delta of updated data from OCM
- use Apollo Server to support subgraphs
- authentication and user management out of the scope of implementation

## TODO
- [x] define user stories
- [x] create list of questions to the requirements
- [x] analyze the questions
- [x] create list of assumptions
- [x] create git repository and initial README.MD with user stories
- [x] investigate Open Charge Map API: https://openchargemap.org/site/develop/api#/
- [x] prepare a list of questions to the requirements
- [x] R&D federated GraphQL gateway
- [ ] import-service
    - [x] initial project setup for import-service
    - [x] boilerplate import-service with Apollo Server
    - [x] define import-service GraphQL schema and mock response
    - [x] implement 'dev' script, add ts-node-dev
    - [x] setup linter and formatter
    - [x] refactor project
        - [x] refactor: extract type definition to separate schema.graphql file
        - [x] refactor: extract resolvers from index.ts
    - [x] define port from PORT environment variable 
    - [x] create Dockerfile for import-service
        - [x] define initial Dockerfile
        - [x] refacor: Dockerfile for production and Dockerfile.dev for development
        - [x] feat: create production Dockerfile
    - [x] implement MongoDB integration
        - [x] define mongoose schema for ImportSession
        - [x] implement db connector as db.ts
        - [x] define mongoose models for OCM data
            - [x] define mongoose model for Country
            - [x] define mongoose models POI, AddressInfo, ConnectionInfo, ConnectionType, LevelType, OperatorInfo, StatusType, SupplyType
        - [x] create index for POI based on DateLastStatusUpdate
    - [x] define DDD structure, refactor existing code, create placeholders
    - [x] define domain models, refactor dao
    - [x] define interfaces for ImportService
    - [x] define interface for OpenChargeMapRepository
    - [x] define interface for OCMPersistenceRepository, ImportSessionRepository
    - [x] define CoreReferenceData
    - [x] fix: issue with start script ERR_UNSUPPORTED_DIR_IMPORT
    - [x] define path aliases @dal, @domain and @presentation
    - [x] implement initial version for ImportService, ImportSessionRepository, OCMPersistenceRepository, OpenChargeMapRepository
    - [x] implement ImportService
    - [x] refactor: implement bootstrap module
    - [x] setup dependency injection
    - [x] redefine ImportService with mocked repositories
    - [x] implement 'storeReferenceData' method for OCMPersistenceRepository
    - [x] fine-tune dao and models according to OpenAPI docs
    - [x] implement 'storePOIs' method for OCMPersistenceRepository
    - [x] implement 'getLastPOIUpdate' for OCMDataPersistenceRepository
    - [x] implement 'create' and 'getAll' methods for ImportSessionRepository
    - [x] implement generic network API
    - [x] dependency injection, implement composition point inside bootstrap function
    - [x] implement 'getReferenceData' method for OpenChargeMapRepository with network api
    - [ ] use transaction
    - [ ] refactor ImportService
    - [ ] implement generic middleware 
    - [ ] define cors configuration
    - [ ] add logger
    - [ ] implement error handling
    - [ ] adjust service to work as a subgraph
    - [ ] unit-tests
    - [ ] etc
- [ ] client-api
    - [ ] initial project setup, bootstrap
    - [ ] define GraphQL schema
    - [ ] define resolvers
    - [ ] define domain models
    - [ ] define interfaces for repository and services
    - [ ] implement services
    - [ ] implement DAO (data access objects)
    - [ ] implement repositories
    - [ ] implement dependency injection
    - [ ] define DB connector
    - [ ] create Dockerfile and Dockerfile.dev
    - [ ] define cors configuration
    - [ ] add logger
    - [ ] implement errror handling
    - [ ] adjust service to work as a subgraph
    - [ ] unit-tests
    - [ ] etc
- [ ] graph-router
    - [ ] create Dockerfile for graph-router
    - [ ] etc
- [ ] docker-compose
    - [x] feat: define initial docker-compose
    - [x] fix: MongoServerError: Authentication failed
    - [ ] add client-api instance
    - [ ] add graph-router instance
    - [ ] etc
